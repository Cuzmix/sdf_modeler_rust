import { Button, Slider, VerticalBox, HorizontalBox, GroupBox, ScrollView } from "std-widgets.slint";

export struct TreeItem {
    depth: int,
    name: string,
    node-type: int,
    is-selected: bool,
    item-index: int,
}

component LabeledSlider inherits HorizontalLayout {
    in property <string> label;
    in property <float> minimum: -5.0;
    in property <float> maximum: 5.0;
    in-out property <float> value;
    callback changed(float);

    spacing: 4px;
    height: 24px;

    Text {
        text: label;
        color: #aaa;
        font-size: 11px;
        vertical-alignment: center;
        width: 20px;
    }
    Slider {
        minimum: root.minimum;
        maximum: root.maximum;
        value <=> root.value;
        changed(val) => { root.changed(val); }
    }
    Text {
        text: "\{round(root.value * 100) / 100}";
        color: #888;
        font-size: 10px;
        vertical-alignment: center;
        width: 40px;
        horizontal-alignment: right;
    }
}

export component MainWindow inherits Window {
    title: "SDF Modeler";
    preferred-width: 1280px;
    preferred-height: 720px;
    background: #1a1a2e;

    // Viewport texture rendered by wgpu
    in-out property <image> viewport-texture;

    // Viewport size for resize handling
    out property <float> viewport-width: viewport-area.width / 1px;
    out property <float> viewport-height: viewport-area.height / 1px;

    // FPS counter
    in-out property <string> fps-text: "0 fps";

    // Selection & properties
    in-out property <bool>   has-selection: false;
    in-out property <string> selected-name: "";
    in-out property <float>  prop-pos-x: 0;
    in-out property <float>  prop-pos-y: 0;
    in-out property <float>  prop-pos-z: 0;
    in-out property <float>  prop-scale-x: 0.5;
    in-out property <float>  prop-scale-y: 0.5;
    in-out property <float>  prop-scale-z: 0.5;

    // Scene graph tree
    in-out property <[TreeItem]> tree-items;
    callback on-tree-item-clicked(int);

    // Callbacks
    callback on-pointer-down(float, float, int);
    callback on-pointer-move(float, float);
    callback on-pointer-up();
    callback on-scroll(float);
    callback on-add-primitive(int);
    callback on-delete-selected();
    callback on-property-changed();

    VerticalLayout {
        // ── Toolbar ─────────────────────────────────────────
        Rectangle {
            height: 36px;
            background: #2d2d2d;
            HorizontalLayout {
                padding-left: 12px;
                padding-right: 12px;
                spacing: 8px;
                alignment: start;

                Text {
                    text: "SDF Modeler";
                    color: #ccc;
                    font-size: 14px;
                    vertical-alignment: center;
                }

                // Spacer
                Rectangle { width: 16px; }

                Button {
                    text: "+ Sphere";
                    clicked => { root.on-add-primitive(0); }
                }
                Button {
                    text: "+ Box";
                    clicked => { root.on-add-primitive(1); }
                }
                Button {
                    text: "+ Cylinder";
                    clicked => { root.on-add-primitive(2); }
                }
                Button {
                    text: "+ Torus";
                    clicked => { root.on-add-primitive(3); }
                }
            }
        }

        // ── Main area: viewport + properties ────────────────
        HorizontalLayout {
            // Viewport
            viewport-area := Rectangle {
                background: #111;

                Image {
                    source: root.viewport-texture;
                    width: parent.width;
                    height: parent.height;
                    image-fit: fill;
                }

                TouchArea {
                    mouse-cursor: crosshair;

                    pointer-event(e) => {
                        if (e.kind == PointerEventKind.down) {
                            root.on-pointer-down(
                                self.mouse-x / 1px,
                                self.mouse-y / 1px,
                                e.button == PointerEventButton.left ? 0 :
                                e.button == PointerEventButton.right ? 1 : 2
                            );
                        }
                        if (e.kind == PointerEventKind.up) {
                            root.on-pointer-up();
                        }
                    }

                    moved => {
                        root.on-pointer-move(self.mouse-x / 1px, self.mouse-y / 1px);
                    }

                    scroll-event(e) => {
                        root.on-scroll(e.delta-y / 1px);
                        return accept;
                    }
                }
            }

            // ── Right Panel: Scene Graph + Properties ─────
            Rectangle {
                width: 260px;
                background: #252530;

                VerticalLayout {
                    padding: 12px;
                    spacing: 0px;

                    // ── Scene Graph header ──
                    Text {
                        text: "Scene Graph";
                        color: #888;
                        font-size: 11px;
                        font-weight: 600;
                    }
                    Rectangle { height: 6px; }

                    // ── Tree items (scrollable) ──
                    ScrollView {
                        min-height: 80px;
                        VerticalLayout {
                            spacing: 0px;
                            for item[idx] in root.tree-items: Rectangle {
                                height: 26px;
                                background: item.is-selected ? #3a3a5a : transparent;
                                border-radius: 3px;

                                HorizontalLayout {
                                    padding-left: (item.depth * 16 + 4) * 1px;
                                    spacing: 6px;
                                    alignment: start;

                                    // Type badge (colored dot)
                                    Rectangle {
                                        width: 10px;
                                        height: 10px;
                                        border-radius: item.node-type < 10 ? 5px : 2px;
                                        background: item.node-type == 0 ? #cc8c66 :
                                                    item.node-type == 1 ? #6699cc :
                                                    item.node-type == 2 ? #99cc66 :
                                                    item.node-type == 3 ? #cc66aa :
                                                    #666666;
                                    }

                                    // Node name
                                    Text {
                                        text: item.name;
                                        color: item.is-selected ? #fff : #ccc;
                                        font-size: 11px;
                                        vertical-alignment: center;
                                    }
                                }

                                TouchArea {
                                    clicked => { root.on-tree-item-clicked(idx); }
                                }
                            }
                        }
                    }

                    // ── Properties section (conditional) ──
                    if root.has-selection: Rectangle {
                        height: 1px;
                        background: #444;
                    }
                    if root.has-selection: VerticalLayout {
                        padding-top: 8px;
                        spacing: 8px;

                        // Node name
                        Text {
                            text: root.selected-name;
                            color: #ddd;
                            font-size: 13px;
                            font-weight: 600;
                        }

                        // Position
                        Text {
                            text: "Position";
                            color: #888;
                            font-size: 11px;
                        }
                        LabeledSlider {
                            label: "X";
                            value <=> root.prop-pos-x;
                            changed(v) => { root.on-property-changed(); }
                        }
                        LabeledSlider {
                            label: "Y";
                            value <=> root.prop-pos-y;
                            changed(v) => { root.on-property-changed(); }
                        }
                        LabeledSlider {
                            label: "Z";
                            value <=> root.prop-pos-z;
                            changed(v) => { root.on-property-changed(); }
                        }

                        // Scale
                        Rectangle { height: 4px; }
                        Text {
                            text: "Scale";
                            color: #888;
                            font-size: 11px;
                        }
                        LabeledSlider {
                            label: "X";
                            minimum: 0.05;
                            maximum: 3.0;
                            value <=> root.prop-scale-x;
                            changed(v) => { root.on-property-changed(); }
                        }
                        LabeledSlider {
                            label: "Y";
                            minimum: 0.05;
                            maximum: 3.0;
                            value <=> root.prop-scale-y;
                            changed(v) => { root.on-property-changed(); }
                        }
                        LabeledSlider {
                            label: "Z";
                            minimum: 0.05;
                            maximum: 3.0;
                            value <=> root.prop-scale-z;
                            changed(v) => { root.on-property-changed(); }
                        }

                        // Delete button
                        Rectangle { height: 12px; }
                        Button {
                            text: "Delete";
                            clicked => { root.on-delete-selected(); }
                        }
                    }
                }
            }
        }

        // ── Status bar ──────────────────────────────────────
        Rectangle {
            height: 24px;
            background: #2d2d2d;
            HorizontalLayout {
                padding-left: 12px;
                padding-right: 12px;
                Text {
                    text: "Phase 6 — Scene Graph";
                    color: #888;
                    font-size: 11px;
                    vertical-alignment: center;
                }
                Rectangle {} // spacer
                Text {
                    text: root.fps-text;
                    color: #888;
                    font-size: 11px;
                    vertical-alignment: center;
                }
            }
        }
    }
}
