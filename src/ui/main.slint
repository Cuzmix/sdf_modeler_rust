import { Button, Slider, VerticalBox, HorizontalBox, GroupBox, ScrollView } from "std-widgets.slint";

export struct TreeItem {
    depth: int,
    name: string,
    node-type: int,
    is-selected: bool,
    item-index: int,
}

export struct GraphNode {
    x: float,
    y: float,
    width: float,
    height: float,
    name: string,
    node-type: int,
    is-selected: bool,
    item-index: int,
    has-input-ports: bool,
    has-single-input: bool,
}

component LabeledSlider inherits HorizontalLayout {
    in property <string> label;
    in property <float> minimum: -5.0;
    in property <float> maximum: 5.0;
    in-out property <float> value;
    callback changed(float);

    spacing: 4px;
    height: 24px;

    Text {
        text: label;
        color: #aaa;
        font-size: 11px;
        vertical-alignment: center;
        width: 20px;
    }
    Slider {
        minimum: root.minimum;
        maximum: root.maximum;
        value <=> root.value;
        changed(val) => { root.changed(val); }
    }
    Text {
        text: "\{round(root.value * 100) / 100}";
        color: #888;
        font-size: 10px;
        vertical-alignment: center;
        width: 40px;
        horizontal-alignment: right;
    }
}

export component MainWindow inherits Window {
    title: "SDF Modeler";
    preferred-width: 1280px;
    preferred-height: 720px;
    background: #1a1a2e;

    // Viewport texture rendered by wgpu
    in-out property <image> viewport-texture;

    // Viewport size for resize handling
    out property <float> viewport-width: viewport-area.width / 1px;
    out property <float> viewport-height: viewport-area.height / 1px;

    // FPS counter
    in-out property <string> fps-text: "0 fps";

    // Selection & properties
    in-out property <bool>   has-selection: false;
    in-out property <string> selected-name: "";
    in-out property <int>    selected-node-type: -1;
    in-out property <float>  prop-pos-x: 0;
    in-out property <float>  prop-pos-y: 0;
    in-out property <float>  prop-pos-z: 0;
    in-out property <float>  prop-scale-x: 0.5;
    in-out property <float>  prop-scale-y: 0.5;
    in-out property <float>  prop-scale-z: 0.5;

    // Scene graph tree
    in-out property <[TreeItem]> tree-items;
    callback on-tree-item-clicked(int);

    // Node graph editor
    in-out property <[GraphNode]> graph-nodes;
    in-out property <string> graph-connections-svg: "";
    in-out property <string> graph-highlight-wire-svg: "";
    in-out property <string> graph-preview-wire-svg: "";
    in-out property <float> graph-canvas-width: 400;
    in-out property <float> graph-canvas-height: 200;
    in-out property <float> graph-pan-x: 0;
    in-out property <float> graph-pan-y: 0;
    callback on-graph-pointer-down(int, float, float);
    callback on-graph-pointer-move(float, float);
    callback on-graph-pointer-up();

    // Callbacks
    callback on-pointer-down(float, float, int);
    callback on-pointer-move(float, float);
    callback on-pointer-up();
    callback on-scroll(float);
    callback on-add-primitive(int);
    callback on-add-transform(int);
    callback on-delete-selected();
    callback on-property-changed();
    callback on-undo();
    callback on-redo();

    FocusScope {
        key-pressed(e) => {
            if (e.text == Key.Delete) {
                root.on-delete-selected();
                return accept;
            }
            if (e.modifiers.control && e.text == "z") {
                root.on-undo();
                return accept;
            }
            if (e.modifiers.control && e.text == "y") {
                root.on-redo();
                return accept;
            }
            return reject;
        }
    }

    VerticalLayout {
        // ── Toolbar ─────────────────────────────────────────
        Rectangle {
            height: 36px;
            background: #2d2d2d;
            HorizontalLayout {
                padding-left: 12px;
                padding-right: 12px;
                spacing: 8px;
                alignment: start;

                Text {
                    text: "SDF Modeler";
                    color: #ccc;
                    font-size: 14px;
                    vertical-alignment: center;
                }

                // Spacer
                Rectangle { width: 16px; }

                Button {
                    text: "+ Sphere";
                    clicked => { root.on-add-primitive(0); }
                }
                Button {
                    text: "+ Box";
                    clicked => { root.on-add-primitive(1); }
                }
                Button {
                    text: "+ Cylinder";
                    clicked => { root.on-add-primitive(2); }
                }
                Button {
                    text: "+ Torus";
                    clicked => { root.on-add-primitive(3); }
                }

                // Spacer
                Rectangle { width: 8px; }

                Button {
                    text: "+ Translate";
                    clicked => { root.on-add-transform(0); }
                }
                Button {
                    text: "+ Rotate";
                    clicked => { root.on-add-transform(1); }
                }
                Button {
                    text: "+ Scale";
                    clicked => { root.on-add-transform(2); }
                }
            }
        }

        // ── Main area: viewport + properties ────────────────
        HorizontalLayout {
            // Viewport
            viewport-area := Rectangle {
                background: #111;

                Image {
                    source: root.viewport-texture;
                    width: parent.width;
                    height: parent.height;
                    image-fit: fill;
                }

                TouchArea {
                    mouse-cursor: crosshair;

                    pointer-event(e) => {
                        if (e.kind == PointerEventKind.down) {
                            root.on-pointer-down(
                                self.mouse-x / 1px,
                                self.mouse-y / 1px,
                                e.button == PointerEventButton.left ? 0 :
                                e.button == PointerEventButton.right ? 1 : 2
                            );
                        }
                        if (e.kind == PointerEventKind.up) {
                            root.on-pointer-up();
                        }
                    }

                    moved => {
                        root.on-pointer-move(self.mouse-x / 1px, self.mouse-y / 1px);
                    }

                    scroll-event(e) => {
                        root.on-scroll(e.delta-y / 1px);
                        return accept;
                    }
                }
            }

            // ── Right Panel: Scene Graph + Properties ─────
            Rectangle {
                width: 260px;
                background: #252530;

                VerticalLayout {
                    padding: 12px;
                    spacing: 0px;

                    // ── Scene Graph header ──
                    Text {
                        text: "Scene Graph";
                        color: #888;
                        font-size: 11px;
                        font-weight: 600;
                    }
                    Rectangle { height: 6px; }

                    // ── Tree items (scrollable) ──
                    ScrollView {
                        min-height: 80px;
                        VerticalLayout {
                            spacing: 0px;
                            for item[idx] in root.tree-items: Rectangle {
                                height: 26px;
                                background: item.is-selected ? #3a3a5a : transparent;
                                border-radius: 3px;

                                HorizontalLayout {
                                    padding-left: (item.depth * 16 + 4) * 1px;
                                    spacing: 6px;
                                    alignment: start;

                                    // Type badge (colored dot/square)
                                    Rectangle {
                                        width: 10px;
                                        height: 10px;
                                        border-radius: item.node-type < 10 ? 5px : 2px;
                                        background: item.node-type == 0 ? #cc8c66 :
                                                    item.node-type == 1 ? #6699cc :
                                                    item.node-type == 2 ? #99cc66 :
                                                    item.node-type == 3 ? #cc66aa :
                                                    item.node-type >= 20 ? #44bbbb :
                                                    #666666;
                                    }

                                    // Node name
                                    Text {
                                        text: item.name;
                                        color: item.is-selected ? #fff : #ccc;
                                        font-size: 11px;
                                        vertical-alignment: center;
                                    }
                                }

                                TouchArea {
                                    clicked => { root.on-tree-item-clicked(idx); }
                                }
                            }
                        }
                    }

                    // ── Properties section ──
                    if root.has-selection: Rectangle {
                        height: 1px;
                        background: #444;
                    }

                    // Primitive properties (node_type 0-9)
                    if root.has-selection && root.selected-node-type < 10: VerticalLayout {
                        padding-top: 8px;
                        spacing: 8px;

                        Text {
                            text: root.selected-name;
                            color: #ddd;
                            font-size: 13px;
                            font-weight: 600;
                        }

                        Text {
                            text: "Position";
                            color: #888;
                            font-size: 11px;
                        }
                        LabeledSlider {
                            label: "X";
                            value <=> root.prop-pos-x;
                            changed(v) => { root.on-property-changed(); }
                        }
                        LabeledSlider {
                            label: "Y";
                            value <=> root.prop-pos-y;
                            changed(v) => { root.on-property-changed(); }
                        }
                        LabeledSlider {
                            label: "Z";
                            value <=> root.prop-pos-z;
                            changed(v) => { root.on-property-changed(); }
                        }

                        Rectangle { height: 4px; }
                        Text {
                            text: "Scale";
                            color: #888;
                            font-size: 11px;
                        }
                        LabeledSlider {
                            label: "X";
                            minimum: 0.05;
                            maximum: 3.0;
                            value <=> root.prop-scale-x;
                            changed(v) => { root.on-property-changed(); }
                        }
                        LabeledSlider {
                            label: "Y";
                            minimum: 0.05;
                            maximum: 3.0;
                            value <=> root.prop-scale-y;
                            changed(v) => { root.on-property-changed(); }
                        }
                        LabeledSlider {
                            label: "Z";
                            minimum: 0.05;
                            maximum: 3.0;
                            value <=> root.prop-scale-z;
                            changed(v) => { root.on-property-changed(); }
                        }

                        Rectangle { height: 12px; }
                        Button {
                            text: "Delete";
                            clicked => { root.on-delete-selected(); }
                        }
                    }

                    // Transform properties (node_type 20-22)
                    if root.has-selection && root.selected-node-type >= 20: VerticalLayout {
                        padding-top: 8px;
                        spacing: 8px;

                        Text {
                            text: root.selected-name;
                            color: #ddd;
                            font-size: 13px;
                            font-weight: 600;
                        }

                        Text {
                            text: root.selected-node-type == 20 ? "Offset" :
                                  root.selected-node-type == 21 ? "Rotation" : "Scale Factor";
                            color: #888;
                            font-size: 11px;
                        }
                        LabeledSlider {
                            label: "X";
                            minimum: root.selected-node-type == 22 ? 0.05 :
                                     root.selected-node-type == 21 ? -3.15 : -5.0;
                            maximum: root.selected-node-type == 22 ? 5.0 :
                                     root.selected-node-type == 21 ? 3.15 : 5.0;
                            value <=> root.prop-pos-x;
                            changed(v) => { root.on-property-changed(); }
                        }
                        LabeledSlider {
                            label: "Y";
                            minimum: root.selected-node-type == 22 ? 0.05 :
                                     root.selected-node-type == 21 ? -3.15 : -5.0;
                            maximum: root.selected-node-type == 22 ? 5.0 :
                                     root.selected-node-type == 21 ? 3.15 : 5.0;
                            value <=> root.prop-pos-y;
                            changed(v) => { root.on-property-changed(); }
                        }
                        LabeledSlider {
                            label: "Z";
                            minimum: root.selected-node-type == 22 ? 0.05 :
                                     root.selected-node-type == 21 ? -3.15 : -5.0;
                            maximum: root.selected-node-type == 22 ? 5.0 :
                                     root.selected-node-type == 21 ? 3.15 : 5.0;
                            value <=> root.prop-pos-z;
                            changed(v) => { root.on-property-changed(); }
                        }

                        Rectangle { height: 12px; }
                        Button {
                            text: "Delete";
                            clicked => { root.on-delete-selected(); }
                        }
                    }

                    // Operation properties (node_type 10-19) — just name + delete
                    if root.has-selection && root.selected-node-type >= 10 && root.selected-node-type < 20: VerticalLayout {
                        padding-top: 8px;
                        spacing: 8px;

                        Text {
                            text: root.selected-name;
                            color: #ddd;
                            font-size: 13px;
                            font-weight: 600;
                        }

                        Rectangle { height: 12px; }
                        Button {
                            text: "Delete";
                            clicked => { root.on-delete-selected(); }
                        }
                    }
                }
            }
        }

        // ── Separator ──────────────────────────────────────
        Rectangle {
            height: 1px;
            background: #444;
        }

        // ── Node Graph Panel ──────────────────────────────
        Rectangle {
            height: 200px;
            background: #1e1e2e;

            VerticalLayout {
                // Panel header
                Rectangle {
                    height: 24px;
                    background: #252535;
                    HorizontalLayout {
                        padding-left: 12px;
                        alignment: start;
                        Text {
                            text: "Node Graph";
                            color: #888;
                            font-size: 11px;
                            font-weight: 600;
                            vertical-alignment: center;
                        }
                    }
                }

                // Clipped pan container
                Rectangle {
                    clip: true;

                    // Canvas (translated by pan offset)
                    Rectangle {
                        x: -root.graph-pan-x * 1px;
                        y: -root.graph-pan-y * 1px;
                        width: max(root.graph-canvas-width * 1px, parent.width + root.graph-pan-x * 1px);
                        height: max(root.graph-canvas-height * 1px, parent.height + root.graph-pan-y * 1px);
                        background: #1e1e2e;

                        // Connection lines (rendered first = behind nodes)
                        Path {
                            commands: root.graph-connections-svg;
                            stroke: #555;
                            stroke-width: 2px;
                            width: parent.width;
                            height: parent.height;
                            viewbox-x: 0;
                            viewbox-y: 0;
                            viewbox-width: parent.width / 1px;
                            viewbox-height: parent.height / 1px;
                        }

                        // Highlighted wire (rendered on top of normal connections)
                        Path {
                            commands: root.graph-highlight-wire-svg;
                            stroke: #88aaff;
                            stroke-width: 3px;
                            width: parent.width;
                            height: parent.height;
                            viewbox-x: 0;
                            viewbox-y: 0;
                            viewbox-width: parent.width / 1px;
                            viewbox-height: parent.height / 1px;
                        }

                        // Preview wire during drag
                        Path {
                            commands: root.graph-preview-wire-svg;
                            stroke: #88aaff;
                            stroke-width: 2px;
                            width: parent.width;
                            height: parent.height;
                            viewbox-x: 0;
                            viewbox-y: 0;
                            viewbox-width: parent.width / 1px;
                            viewbox-height: parent.height / 1px;
                        }

                        // Node cards (rendered after = on top)
                        for gnode[idx] in root.graph-nodes: Rectangle {
                            x: gnode.x * 1px;
                            y: gnode.y * 1px;
                            width: gnode.width * 1px;
                            height: gnode.height * 1px;
                            border-radius: 6px;
                            background: gnode.is-selected ? #3a3a6a : #2a2a3a;
                            border-color: gnode.is-selected ? #6688cc : #3a3a4a;
                            border-width: gnode.is-selected ? 2px : 1px;
                            clip: false;

                            HorizontalLayout {
                                padding-left: 12px;
                                padding-right: 12px;
                                spacing: 6px;
                                alignment: start;

                                // Type badge
                                Rectangle {
                                    width: 10px;
                                    height: 10px;
                                    border-radius: gnode.node-type < 10 ? 5px : 2px;
                                    background: gnode.node-type == 0 ? #cc8c66 :
                                                gnode.node-type == 1 ? #6699cc :
                                                gnode.node-type == 2 ? #99cc66 :
                                                gnode.node-type == 3 ? #cc66aa :
                                                gnode.node-type >= 20 ? #44bbbb :
                                                #666666;
                                }

                                // Node name
                                Text {
                                    text: gnode.name;
                                    color: gnode.is-selected ? #fff : #ccc;
                                    font-size: 11px;
                                    vertical-alignment: center;
                                    overflow: elide;
                                }
                            }

                            // Output port (right edge center) — all nodes
                            Rectangle {
                                x: (gnode.width - 4) * 1px;
                                y: (gnode.height / 2 - 4) * 1px;
                                width: 8px;
                                height: 8px;
                                border-radius: 4px;
                                background: #666;
                                border-color: #999;
                                border-width: 1px;
                            }

                            // Input port top (left edge, 1/3 height) — operations only
                            if gnode.has-input-ports: Rectangle {
                                x: -4px;
                                y: (gnode.height / 3 - 4) * 1px;
                                width: 8px;
                                height: 8px;
                                border-radius: 4px;
                                background: #666;
                                border-color: #999;
                                border-width: 1px;
                            }

                            // Input port bottom (left edge, 2/3 height) — operations only
                            if gnode.has-input-ports: Rectangle {
                                x: -4px;
                                y: (gnode.height * 2 / 3 - 4) * 1px;
                                width: 8px;
                                height: 8px;
                                border-radius: 4px;
                                background: #666;
                                border-color: #999;
                                border-width: 1px;
                            }

                            // Single input port (left edge, center) — transforms only
                            if gnode.has-single-input: Rectangle {
                                x: -4px;
                                y: (gnode.height / 2 - 4) * 1px;
                                width: 8px;
                                height: 8px;
                                border-radius: 4px;
                                background: #666;
                                border-color: #999;
                                border-width: 1px;
                            }
                        }
                    }

                    // Overlay TouchArea (on top, handles ALL pointer events)
                    TouchArea {
                        mouse-cursor: default;

                        pointer-event(e) => {
                            if (e.kind == PointerEventKind.down) {
                                root.on-graph-pointer-down(
                                    e.button == PointerEventButton.left ? 0 :
                                    e.button == PointerEventButton.right ? 1 : 2,
                                    self.mouse-x / 1px,
                                    self.mouse-y / 1px
                                );
                            }
                            if (e.kind == PointerEventKind.up) {
                                root.on-graph-pointer-up();
                            }
                        }

                        moved => {
                            root.on-graph-pointer-move(self.mouse-x / 1px, self.mouse-y / 1px);
                        }
                    }
                }
            }
        }

        // ── Status bar ──────────────────────────────────────
        Rectangle {
            height: 24px;
            background: #2d2d2d;
            HorizontalLayout {
                padding-left: 12px;
                padding-right: 12px;
                Text {
                    text: "Phase 8 — Codegen + Transforms";
                    color: #888;
                    font-size: 11px;
                    vertical-alignment: center;
                }
                Rectangle {} // spacer
                Text {
                    text: root.fps-text;
                    color: #888;
                    font-size: 11px;
                    vertical-alignment: center;
                }
            }
        }
    }
}
